<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Bayesian Spectral Unmixing | Earth.etc </title> <meta name="author" content="Muhamad Nasir Lukman"> <meta name="description" content="Bayesian approach on spectral unmixing with an example case using hyperspectral images of sandstone drill core sample."> <meta name="keywords" content="remote sensing, gis, image analysis, machine learning, geology, earth science, earth observation, geophysics, planetary science, satelite"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%8C%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://nasirlukman.github.io/blog/2024/bayes-unmixing/"> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Earth.etc </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Bayesian Spectral Unmixing</h1> <p class="post-meta"> November 24, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>In the <a href="https://nasirlukman.github.io/blog/2024/distance/">previous post</a> we discussed how spectral unmixing inherently suffers from uncertaintyâ€”stemming both from the data and the model. Traditional optimization approaches, like the one we used earlier, often assume that these uncertainties are either negligible or nonexistent. However, in practice, this is rarely the case.</p> <p>In this post, weâ€™ll take a brief look at the Bayesian approach to spectral unmixing, which explicitly accounts for these uncertainties. By incorporating them into the model, we propagate the uncertainty through to the final results. Instead of a single vector of mineral abundances, the Bayesian approach provides a probability distribution for these abundances, offering deeper insight into the confidence we have in our estimates.</p> <p>While we wonâ€™t dive too deeply into the math, a basic formulation helps set the stage. The linear mixture model can be expressed as:</p> \[\mathbf{y} = \mathbf{E} \mathbf{a} + \mathbf{e}\] <p>where:</p> <ul> <li>\(\mathbf{y}\) is the observed spectrum,</li> <li>\(\mathbf{E}\) is the endmembers matrix,</li> <li>\(\mathbf{a}\) is the abundance vector,</li> <li>\(\mathbf{e}\) represents error terms/uncertainty.</li> </ul> <blockquote> <p>Context for this post: We are focusing on unmixing for minerals on particulate surfaces (e.g., rock surfaces). Due to multiple-scattering effects, the linear relationship above does not hold when using reflectance data. Instead, we will use the <a href="https://en.wikipedia.org/wiki/Single-scattering_albedo" rel="external nofollow noopener" target="_blank">Single Scattering Albedo (SSA)</a> which derived from Hapkeâ€™s Model, as it better handles these effect. For those interested in the underlying theory, I highly recommend consulting <a href="https://www.cambridge.org/core/books/theory-of-reflectance-and-emittance-spectroscopy/C266E1164D5E14DA18141F03D0E0EAB0" rel="external nofollow noopener" target="_blank">this book</a>; these two papers that really helps me a lot with the subject: <a href="https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/JB094iB10p13619" rel="external nofollow noopener" target="_blank">[1]</a>, <a href="https://www.researchgate.net/publication/264564339_A_Review_of_Nonlinear_Hyperspectral_Unmixing_Methods" rel="external nofollow noopener" target="_blank">[2]</a>; or other sources (including my <a href="https://www.google.com/url?sa=t&amp;source=web&amp;rct=j&amp;opi=89978449&amp;url=http://essay.utwente.nl/101556/1/Lukman_MA_ITC.pdf&amp;ved=2ahUKEwjqlY-m8faJAxUdw6ACHRUJKj0QFnoECBkQAQ&amp;usg=AOvVaw3Tbo1LEGrTchQ7edNZoxGt" rel="external nofollow noopener" target="_blank">thesis</a>ðŸ˜‰)</p> </blockquote> <h3 id="bayesian-framework">bayesian Framework</h3> <p>Following <a href="https://en.wikipedia.org/wiki/Bayes%27_theorem" rel="external nofollow noopener" target="_blank">Bayesâ€™ Theorem</a>, we can represent the spectral unmixing problem as:</p> \[P(\mathbf{a}, \sigma^2 \mid \mathbf{y}, \mathbf{E}) \propto P(\mathbf{y} \mid \mathbf{a}, \sigma^2, \mathbf{E}) P(\mathbf{a}) P(\sigma^2)\] <p>where:</p> <ul> <li>\(P(\mathbf{a}, \sigma^2 \mid \mathbf{y}, \mathbf{E})\) is the posterior distribution of the abundance vector and error variance given the observed spectrum and endmembers,</li> <li>\(P(\mathbf{y} \mid \mathbf{a}, \sigma^2, \mathbf{E})\) is the likelihood of the observed spectrum,</li> <li>\(P(\mathbf{a})\) is the prior distribution of the abundance vector,</li> <li>\(P(\sigma^2)\) is the prior distribution of the error variance,</li> <li>and \(\propto\) denote proportionality</li> </ul> <p>We assume that the error term \(\mathbf{e}\) is normally distributed, giving us a <a href="https://distribution-explorer.github.io/continuous/normal.html" rel="external nofollow noopener" target="_blank">Normal</a> likelihood:</p> \[P(\mathbf{y} \mid \mathbf{a}, \sigma^2, \mathbf{E}) = \mathcal{N}(\mathbf{y} \mid \mathbf{E}\mathbf{a}, \sigma^2\mathbf{I}),\] <p>where \(\mathbf{I}\) is the identity matrix.</p> <p>For the abundance vector \(\mathbf{a}\), we use a <a href="https://distribution-explorer.github.io/multivariate_continuous/dirichlet.html" rel="external nofollow noopener" target="_blank">Dirichlet</a> prior to enforce the non-negativity and sum-to-one constraints:</p> \[P(\mathbf{a}) = \mathcal{D}(\mathbf{a} \mid \boldsymbol{\alpha}),\] <p>where \(\boldsymbol{\alpha}\) is the concentration parameter.</p> <p>For the error variance \(\sigma^2\), we assign a <a href="https://distribution-explorer.github.io/continuous/halfcauchy.html" rel="external nofollow noopener" target="_blank">Half-Cauchy</a> prior:</p> \[P(\sigma^2) = \mathcal{HC}(\sigma^2 \mid \beta),\] <p>with the scale hyperparamter \(\beta\) given a <a href="https://distribution-explorer.github.io/continuous/uniform.html" rel="external nofollow noopener" target="_blank">Unifrom</a> prior such as:</p> \[P(\beta) = \mathcal{U}(\beta \mid 0, 0^{-4}).\] <p>Terefore, we can summarize the hierarchical structure of the random variables as:</p> \[\mathbf{y} \sim \mathcal{N}(\mathbf{E}\mathbf{a}, \sigma^2\mathbf{I})\] \[\mathbf{a} \sim \mathcal{D}(\boldsymbol{\alpha})\] \[\sigma^2 \sim \mathcal{HC}(\beta)\] \[\beta \sim \mathcal{U}(0, 10^{-4})\] <p>As you might guess, this formulation of the posterior distribution cannot be solved analytically. Instead, we use <a href="https://en.wikipedia.org/wiki/Markov_chain_Monte_Carlo" rel="external nofollow noopener" target="_blank"><em>Markov Chain Monte Caelo (MCMC)</em></a> to sample and estimate the posterior. For educational purposes, Iâ€™ve implemented a custom sampler based on the <a href="https://en.wikipedia.org/wiki/Metropolis%E2%80%93Hastings_algorithm" rel="external nofollow noopener" target="_blank"><em>Metropolis-Hastings Random Walk</em></a> in Python. In practice, however, modern samplers like <em>NUTS (No-U-Turn Sampler)</em> in an established library such as <a href="https://www.pymc.io/welcome.html" rel="external nofollow noopener" target="_blank">PyMC</a> are often preferable. They offer a more efficient and streamlined sampling process, sparing users the burden of directly managing the nasty mathematics behind these algorithms.</p> <p>In the Metropolis-Hastings algorithm, we iteratively draw samples from the posterior. For each new sample, we evaluate its probability relative to the previous sample. The sample is either accepted or rejected based on this evaluation. Over many iterations, the density of accepted samples approximates the true posterior distribution.</p> <p>To illustrate, the animation below shows the random walk process for sampling three abundance parameters in a mixture of three endmembers. The blue regions represent the true posterior distribution. Notice how the sampler, starting from a random point in the parameter space, gradually converges to the high-probability regions:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/post_2_random_walk-480.webp 480w,/assets/img/post_2_random_walk-800.webp 800w,/assets/img/post_2_random_walk-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/post_2_random_walk.gif" class="img-fluid rounded" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Image 1. Random Walk Example on a known target distribution </div> <p><img src="post_2_random_walk.gif" alt="randm Walk"> <img src="post_2_random_walk.gif" alt="Funny Cat" width="300" height="200"></p> <h3 id="practical-example">Practical Example</h3> <p>In this example, we are dealing with a sandstone rock sample. We have three minerals that represent the three main component of sandstone rock which quartz as the grains, clay as the matrix and carbonates as the cement. We assume that the endmember spectra is known for this mineral either by direct measurement in laboratory, from a spectral library, or from an endmember extraction algorithm if we are dealing with hyperspectral imagery. We wil begin the example with a single mixed spectra as shown in image below:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/post_2_data-480.webp 480w,/assets/img/post_2_data-800.webp 800w,/assets/img/post_2_data-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/post_2_data.png" class="img-fluid rounded" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Image 2. Endmember spectra for Carbonate, Quartz, Clay minerals, and the observed mixed spectra </div> <p>pharagraph</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/post_2_trace_plot-480.webp 480w,/assets/img/post_2_trace_plot-800.webp 800w,/assets/img/post_2_trace_plot-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/post_2_trace_plot.png" class="img-fluid rounded" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Image 3. Marginal posterior distribution of each endmembers abundance and its trace plots </div> <p>pharagraph</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/post_2_corner_plot-480.webp 480w,/assets/img/post_2_corner_plot-800.webp 800w,/assets/img/post_2_corner_plot-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/post_2_corner_plot.png" class="img-fluid rounded" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Image 4. Corner plot of the marginal posterior showing correlations between each endmember abundances </div> <p>pharagraph</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/post_2_ternary-480.webp 480w,/assets/img/post_2_ternary-800.webp 800w,/assets/img/post_2_ternary-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/post_2_ternary.png" class="img-fluid rounded" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Image 5. Ternary plot </div> <p>pharagraph</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/post_2_modeled_spectra-480.webp 480w,/assets/img/post_2_modeled_spectra-800.webp 800w,/assets/img/post_2_modeled_spectra-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/post_2_modeled_spectra.png" class="img-fluid rounded" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Image 6. Observed spectra vs distribution of the modeled spectra </div> <p>pharagraph</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/post_2_rock_sample-480.webp 480w,/assets/img/post_2_rock_sample-800.webp 800w,/assets/img/post_2_rock_sample-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/post_2_rock_sample.png" class="img-fluid rounded" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Image 7. Bayesian spectral unmixing result on a hyperspectral image of a rock sample </div> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/distance/">Different Distance Metrics Example in Spectral Unmixing</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> Â© Copyright 2024 Muhamad Nasir Lukman. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?4a129fbf39254905f505c7246e641eaf"></script> <script defer src="/assets/js/copy_code.js?906085072389244b4db0c89c5b1dd28d" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-NY818B7N0G"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-NY818B7N0G");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>